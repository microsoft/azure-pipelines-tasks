pr:
  - master

jobs:
- job: detect_changes
  displayName: Detect changes
  # we only test tasks on a PR and ignore forks since for security reasosns PAT tokens pipeline variable will not be available for fork's PRs.
  condition: and(in(variables['build.reason'], 'PullRequest', 'Manual'), eq(variables['System.PullRequest.IsFork'], 'False'))
  pool:
    vmImage: ubuntu-20.04
  steps:
  - script: |
      git remote add ms https://github.com/microsoft/azure-pipelines-tasks.git
      git fetch ms master > tmp 2>&1 || cat tmp > '/tmp/stderr-contents-git_fetch.txt'
      git diff --name-only ms/master
      echo "##vso[task.setvariable variable=TASKS;isoutput=true]$(node ./ci/ci-test-tasks/detect-changed-tasks.js $(git diff --name-only ms/master))"
    displayName: 'Detect changed tasks'
    name: detect
 
- job: run_main_test_pipeline
  displayName: Run main test pipeline
  # condition: gt(length(dependencies.detect_changes.outputs['detect.TASKS']), 0)
  dependsOn: detect_changes
  variables:
      - name: tasks
        # value: $[dependencies.detect_changes.outputs['detect.TASKS']]
        value: DownloadPackageV1
  pool:
    vmImage: ubuntu-20.04
  steps:
  - checkout: none
  - script: |
      echo $(tasks)
      npm i axios
      node ./ci/ci-test-tasks/run-main-and-verify.js $(ADOToken) $(ADOUrl) $(System.TeamProject) $(MainPipelineId) $(tasks)
    displayName: 'Run test pipelines and verify results'
    name: run_main_and_verify
    failOnStderr: true
