parameters:
- name: task_name
  type: string

steps:
- checkout: self
  fetchDepth: 1

- checkout: AzureDevOps
  fetchDepth: 1

- task: DownloadBuildArtifacts@0
  inputs:
    buildType: specific
    buildVersionToDownload: specific
    project: TestProject
    buildId: 841
    pipeline: FORK-TASKS
    artifactName: IndividualNugetPackages
    downloadPath: IndividualNugetPackagesDownloaded
  displayName: Download Artifact

- script: node azure-pipelines-tasks\ci\courtesy-push\courtesy-push.js AzureDevOps\.nuget\externals\UnifiedDependencies.xml IndividualNugetPackagesDownloaded\IndividualNugetPackages\unified_deps.xml
  displayName: Update unified deps

- powershell: |
    $currentSprint = (Invoke-WebRequest https://whatsprintis.it/sprint -Headers @{"Accept"="application/json"} | ConvertFrom-Json).sprint
    $hotfixBranch = "users/$(username)/m${currentSprint}/UpdateUnifiedDeps"

    $gitUrl = "https://$(AzDoToken)@dev.azure.com/v-mazayt0/AzureDevOps/_git/AzureDevOps"
    $repositoryId = "AzureDevOps"

    Write-Host "Pushing hotfixBranch to AzureDevOps"
    cd AzureDevOps
    git checkout -b $hotfixBranch
    git config --global user.email "$(username)@microsoft.com"
    git config --global user.name "$(username)"

    git add .nuget\externals\UnifiedDependencies.xml
    
    git commit -m "Courtesy bump of tasks"
    git push $gitUrl $hotfixBranch --force

    Write-Host "Creating Pull Request"
    cd ..\azure-pipelines-tasks\ci\courtesy-push
    npm install
    node open-hotfix-pr.js $repositoryId $hotfixBranch "${{ parameters.task_name }}"
  displayName: Create PR in Azure DevOps
  env:
    TOKEN: $(AzDoToken)