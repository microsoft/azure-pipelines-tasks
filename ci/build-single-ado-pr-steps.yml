parameters:
- name: task_name
  type: string

steps:
- checkout: self
  fetchDepth: 1

- task: NodeTool@0
  displayName: Use node 20
  inputs:
    versionSpec: 20.x

- script: |
    cd azure-pipelines-tasks
    npm install
  displayName: npm install

- script: |
    cd azure-pipelines-tasks/ci/courtesy-push
    npm install
  displayName: npm install for courtesy push

- task: DownloadBuildArtifacts@0
  inputs:
    artifactName: IndividualNugetPackages
    downloadPath: $(Build.SourcesDirectory)/IndividualNugetPackagesDownloaded
  displayName: Download Artifact

- powershell: ./azure-pipelines-tasks/ci/set-sprint-variables.ps1
  displayName: Set currentSprint variables

- powershell: |
    $currentDate = Get-Date -Format "yyyyMMdd-HHmm"
    Write-Host "##vso[task.setVariable variable=currentDate]$currentDate"
  displayName: Set currentDate variable

# returns branchName
- template: /ci/generate-branch-name.yml@self

- script: node azure-pipelines-tasks\ci\courtesy-push\courtesy-push.js $(Build.SourcesDirectory)/IndividualNugetPackagesDownloaded\IndividualNugetPackages\unified_deps.xml
  displayName: Update unified deps and create branch
  env:
    USERNAME: $(Build.RequestedFor)
    PAT: $(System.AccessToken)
    USEREMAIL: $(Build.RequestedForEmail)
    BRANCH_NAME: $(branchName)

