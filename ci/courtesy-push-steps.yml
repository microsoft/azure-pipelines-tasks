steps:

# Clean
- checkout: self
  clean: true

# Use node 20, npm 9
- task: NodeTool@0
  displayName: Use node 20
  inputs:
    versionSpec: 20.x

# Use NuGet 4
- task: NuGetToolInstaller@0
  displayName: Use NuGet 6
  inputs:
    versionSpec: 6.0.0

- task: NpmAuthenticate@0
  inputs:
    workingFile: .npmrc

# npm ci
- script: npm ci
  displayName: npm ci

# Set variables
- powershell: .\ci\set-publish-variables.ps1
  displayName: Set publish variables
  env:
    TASKS_BUILD_ARTIFACT: $(tasksBuildArtifact)

# Download slices
- powershell: .\ci\download-built.ps1
  displayName: Download built packages
  env:
    SYSTEM_ACCESSTOKEN: $(system.accessToken)
    TASKS_BUILD_ARTIFACT: $(tasksBuildArtifact)

# Stage milestone
# TODO: Rename this.. we are staging task packages not the milestone.
- script: node .\ci\stage-milestone.js $(tasksBuildArtifact)
  displayName: Stage milestone

# Stage per task NuGet package
- script: npm run package
  displayName: npm run package
  env:
    COURTESY_PUSH: $(courtesyPush)

# Update build number
- powershell: |
    Write-Host "##vso[build.updatebuildnumber]$(aggregate_version)"
  displayName: Update build number

- powershell: |
    cd $(Build.SourcesDirectory)/ci/courtesy-push
    npm ci
  displayName: npm ci (courtesy-push)

# Copy local nuget packages to mimic the artifact download structure
- task: CopyFiles@2
  inputs:
    SourceFolder: '$(Build.SourcesDirectory)/_package/nuget-packages'
    Contents: '**'
    TargetFolder: '$(Build.SourcesDirectory)/IndividualNugetPackagesDownloaded/IndividualNugetPackages'
    OverWrite: true
  displayName: Copy nuget packages to artifact location

- powershell: $(Build.SourcesDirectory)/ci/set-sprint-variables.ps1
  displayName: Set currentSprint variables

- powershell: |
    $currentDate = Get-Date -Format "yyyyMMdd-HHmm"
    Write-Host "##vso[task.setVariable variable=currentDate]$currentDate"
  displayName: Set currentDate variable

- template: /ci/generate-branch-name.yml@self
- template: /ci/get-AzDo-pat.yml@self

- script: node $(Build.SourcesDirectory)/ci/courtesy-push/courtesy-push.js $(Build.SourcesDirectory)/IndividualNugetPackagesDownloaded/IndividualNugetPackages/unified_deps.xml
  name: createCourtesyPushPR
  displayName: Update unified deps and create branch
  env:
    TOKEN: $(AzDo_PAT)
    BRANCH_NAME: $(branchName)
    DRYRUN: $(isDryRun)
    USERNAME: $(username)

