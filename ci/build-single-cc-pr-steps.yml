parameters:
- name: task_name
  type: string

steps:
- checkout: self
  fetchDepth: 1

- checkout: ConfigChange
  fetchDepth: 1

- task: DownloadBuildArtifacts@0
  inputs:
    buildType: specific
    project: TestProject
    buildVersionToDownload: specific
    buildId: 822
    pipeline: FORK-TASKS
    artifactName: hotfix
    downloadPath: hotfixArtifact
  displayName: Download hotfix Artifact

- powershell: |
    $currentSprint = (Invoke-WebRequest https://whatsprintis.it/sprint -Headers @{"Accept"="application/json"} | ConvertFrom-Json).sprint
    $taskName = "${{ parameters.task_name }}"
    ####
    ls hotfixArtifact
    ls hotfixArtifact/hotfix
    $hotfixFolderPath = "tfs/m${currentSprint}/$taskName-hotfix"
    Write-Host $hotfixFolderPath
    Copy-Item -Path hotfixArtifact/hotfix -Destination AzureDevOps.ConfigChange/$hotfixFolderPath -Recurse

    ls AzureDevOps.ConfigChange/$hotfixFolderPath

    git status

    Write-Host "/$hotfixFolderPath"

    # Build the hotfix branch name
    $hotfixBranch = "users/$(username)/m${currentSprint}/$taskName/taskHotFix"

    $gitUrl = "https://$(AzDoToken)@dev.azure.com/v-mazayt0/AzureDevOps/_git/AzureDevOps.ConfigChange"
    $repositoryId ="AzureDevOps.ConfigChange"

    # Push branch to git
    Write-Host "Pushing branch to AzureDevOps"
    cd AzureDevOps.ConfigChange
    git checkout -b $hotfixBranch
    git config --global user.email "$(username)@microsoft.com"
    git config --global user.name "$(username)"

    git add /$hotfixFolderPath
    
    git commit -m "Hotfix $taskName task"
    Write-Host 'Trying to push to the remote branch..'
    git push $gitUrl $hotfixBranch --force

    Write-Host "Creating Pull Request"
    cd ..\azure-pipelines-tasks\ci\courtesy-push
    npm install
    node open-hotfix-pr.js $repositoryId $hotfixBranch $taskName

    Write-Host "Creating Release"
    node create-hotfix-release.js $hotfixFolderPath $taskName
  displayName: Create PR in AzureDevOps.ConfigChange
  env:
    TOKEN: $(AzDoToken)
