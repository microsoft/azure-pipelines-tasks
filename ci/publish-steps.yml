steps:

# Clean
- checkout: self
  clean: true

# Use node 8, npm 5
- task: NodeTool@0
  displayName: Use node 8
  inputs:
    versionSpec: "8.x"

# Use NuGet 4
- task: NuGetToolInstaller@0
  displayName: Use NuGet 4
  inputs:
    versionSpec: 4.0.0

# npm install
- script: npm install
  displayName: npm install

# Set variables
- powershell: .\ci\set-publish-variables.ps1
  displayName: Set publish variables

# Download slices
- powershell: .\ci\download-slices.ps1
  displayName: Download slices
  env:
    SYSTEM_ACCESSTOKEN: $(system.accessToken)
  #condition: ne(variables['DISTRIBUTEDTASK_USE_PERTASK_NUGET'], 'true')

# Stage milestone
- script: node .\ci\stage-milestone.js
  displayName: Stage milestone
  #condition: ne(variables['DISTRIBUTEDTASK_USE_PERTASK_NUGET'], 'true')

# Create packages.config for restoring previous milestones
- script: node .\ci\create-restore-config.js
  displayName: Create packages.config for restoring previous milestones
  #condition: ne(variables['DISTRIBUTEDTASK_USE_PERTASK_NUGET'], 'true')

# Restore previous milestones
- task: NuGetCommand@2
  displayName: Restore previous milestones
  inputs:
    command: restore
    solution: _package\packages.config
    selectOrConfig: select
    feedRestore: $(task_milestone_feed_name)
    includeNuGetOrg: false
    packagesDirectory: $(system.defaultWorkingDirectory)\_package\restore
  condition: ne(variables['DISTRIBUTEDTASK_USE_PERTASK_NUGET'], 'true')

# Stage aggregate
- script: node .\ci\stage-aggregate.js
  displayName: Stage aggregate
  condition: ne(variables['DISTRIBUTEDTASK_USE_PERTASK_NUGET'], 'true')

# Publish aggregate artifact
- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: _package/publish-layout
    artifactName: TaskPackage
    artifactType: container
  condition: ne(variables['DISTRIBUTEDTASK_USE_PERTASK_NUGET'], 'true')

# Stage per task nuget package
- script: node .\ci\per-task-nuget-package.js
  displayName: Stage per task nuget package
  condition: eq(variables['DISTRIBUTEDTASK_USE_PERTASK_NUGET'], 'true')

# Publish per task artifact
- task: PublishBuildArtifacts@1
  displayName: Publish per task artifact
  inputs:
    pathToPublish: _package\per-task-publish
    artifactName: PerTaskPackages
    artifactType: container
  condition: eq(variables['DISTRIBUTEDTASK_USE_PERTASK_NUGET'], 'true')

# Publish milestone package
- task: NuGetCommand@2
  displayName: Publish milestone package
  condition: and(succeeded(), variables.publish_milestone)
  inputs:
    command: push
    searchPatternPush: _package\vsts-tasks-milestone.$(milestone_version).nupkg
    nuGetFeedType: internal
    feedPublish: $(task_milestone_feed_name)

# Update build number
- script: "echo ##vso[build.updatebuildnumber]$(aggregate_version)"
  displayName: Update build number
