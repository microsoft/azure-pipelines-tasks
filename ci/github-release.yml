steps:
- checkout: self
  clean: true

- task: NodeTool@0
  displayName: Use node 20
  inputs:
    versionSpec: 20.x

- powershell: ./ci/set-sprint-variables.ps1
  displayName: Set currentSprint variables

- template: /ci/generate-branch-name.yml@self
  parameters:
    prefix: releases

- powershell: |
    $releaseBranch = "$(branchName)"
    $isDryRun = "$(isDryRun)"

    # add config entry to avoid errors while pulling
    git config --global user.email "$(username)@microsoft.com"
    git config --global user.name "$(username)"

    Write-Host 'Enabling verbose git tracing..'
    git config --global http.verbose true
    $env:GIT_TRACE = 1
    $env:GIT_CURL_VERBOSE = 1

    # Pull commits from remote and push branch to git
    git checkout -b $releaseBranch
    if( $isDryRun -eq 'true' ) {
      Write-Host "DRY RUN: Skipping Git push operations to remote repository"
    }else{
        Write-Host "Trying to pull the remote branch.."
        git pull https://$(GitHubPAT)@github.com/microsoft/azure-pipelines-tasks $releaseBranch
        if (-not $?) {
          Write-Host "Failed to pull the remote branch. This is expected if the remote branch doesn't exist."
        }
        Write-Host "Trying to push to the remote branch.."
        git push https://$(GitHubPAT)@github.com/microsoft/azure-pipelines-tasks $releaseBranch
    }
  displayName: Push release branch

- powershell: |
    $releaseBranch = "$(branchName)"
    $isDryRun = "$(isDryRun)"

    if (($(currentSprintWeek) -eq 3) -or ($isDryRun -eq 'true')) {
      cd $(System.DefaultWorkingDirectory)/ci/ci-release-notes
      npm ci
      node release-notes.js --token $(GitHubPAT) --version $(currentSprint) --releaseBranch $releaseBranch --isDryRun $isDryRun
    } else {
      echo "Skipping since release notes generating on week 3"
    }
  continueOnError: true
  displayName: Create Release
