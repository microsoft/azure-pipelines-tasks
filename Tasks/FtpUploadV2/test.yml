trigger: none

pool:
  name: Default

jobs:
- job: FtpUploadTest
  displayName: 'FTP Upload Test'
  steps:
  - checkout: none

  ############################################
  # Enable OpenSSH Server
  ############################################
  - powershell: |
      Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0
      Start-Service sshd
      Set-Service sshd -StartupType Automatic
    displayName: Enable OpenSSH Server

  ############################################
  # Configure authorized_keys
  ############################################
  - powershell: |
      $sshDir = "$env:USERPROFILE\.ssh"
      New-Item -ItemType Directory -Force -Path $sshDir | Out-Null

      # Public key must match secure file key
      @"
      ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCm+zJDnfjUR5YSV1RLRSxA+zPx1G2rDQ7L5o+Oz330w9d9kLPNqnekr5YLZOTb+gGFMcyWN8jDKUj03q51syKFeZNaZX81vLXXgwB+NaBF3FOw3IPeK7vSWcJJoYt+9pjpjbssHWeJxo7YAaOGsiXoxSoJNhwKqMs4tm26/kdbuC6guE9M2AkXkvE+PhZGs5RN97jiaq5djgLKEZU+nkTkKLn+k5s+fZu6HGL5S12yUYHsvCxOAvVNg2K803d02BSZkuJ1+cBK+QwWypYFP3FQEk5UizUhF5FE8vZSJsvkdRuWQRKMaSMUVFZt7C31IlAHHVo9em0IIHnmzNo4CJ1P redmond\rajmishra@CPC-rajmi-N86J2
      "@ | Out-File "$sshDir\authorized_keys" -Encoding ascii

      # Set permissions - use proper syntax for icacls with quotes
      icacls "$sshDir\authorized_keys" /inheritance:r
      icacls "$sshDir\authorized_keys" /grant "${env:USERNAME}:(F)"
    displayName: Configure authorized_keys

  ############################################
  # Install SSH Key Task (Secure File)
  ############################################
  - task: InstallSSHKey@0
    inputs:
      knownHostsEntry: 'localhost ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ=='
      sshPublicKey: 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCm+zJDnfjUR5YSV1RLRSxA+zPx1G2rDQ7L5o+Oz330w9d9kLPNqnekr5YLZOTb+gGFMcyWN8jDKUj03q51syKFeZNaZX81vLXXgwB+NaBF3FOw3IPeK7vSWcJJoYt+9pjpjbssHWeJxo7YAaOGsiXoxSoJNhwKqMs4tm26/kdbuC6guE9M2AkXkvE+PhZGs5RN97jiaq5djgLKEZU+nkTkKLn+k5s+fZu6HGL5S12yUYHsvCxOAvVNg2K803d02BSZkuJ1+cBK+QwWypYFP3FQEk5UizUhF5FE8vZSJsvkdRuWQRKMaSMUVFZt7C31IlAHHVo9em0IIHnmzNo4CJ1P'
      sshKeySecureFile: test_ssh_key
    displayName: Install SSH Key

  ############################################
  # Verify SSH works
  ############################################
  - powershell: |
      # Remove old known_hosts to avoid conflicts
      $knownHostsPath = "$env:USERPROFILE\.ssh\known_hosts"
      if (Test-Path $knownHostsPath) {
          Remove-Item $knownHostsPath -Force
      }
      
      ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=NUL localhost "echo SSH_OK"
    displayName: Verify SSH Connection

  ############################################
  # Install IIS FTP Server
  ############################################
  - powershell: |
      Install-WindowsFeature Web-Server, Web-Ftp-Server, Web-Ftp-Service, Web-Ftp-Ext
    displayName: Install FTP Server

  ############################################
  # Configure FTP
  ############################################
  - powershell: |
      $ftpRoot = "C:\ftp"
      New-Item -ItemType Directory -Force -Path $ftpRoot | Out-Null

      net user ftpuser Password@123 /add
      icacls $ftpRoot /grant ftpuser:(OI)(CI)F

      Import-Module WebAdministration

      New-WebFtpSite `
        -Name LocalFtp `
        -Port 21 `
        -PhysicalPath $ftpRoot `
        -Force

      Set-ItemProperty IIS:\Sites\LocalFtp `
        -Name ftpServer.security.authentication.basicAuthentication.enabled `
        -Value $true

      Add-WebConfiguration `
        -Filter "/system.ftpServer/security/authorization" `
        -PSPath IIS:\ `
        -Value @{ users="ftpuser"; permissions="Read,Write"; accessType="Allow" }

      Restart-WebItem IIS:\Sites\LocalFtp
    displayName: Configure FTP

  ############################################
  # Create FTP test files (runtime only)
  ############################################
  - powershell: |
      New-Item -ItemType Directory -Force -Path test-data\sub | Out-Null
      "hello" | Out-File test-data\file1.txt
      "world" | Out-File test-data\sub\file2.txt
    displayName: Create FTP Test Files

  ############################################
  # FTP Upload Task
  ############################################
  - task: FtpUpload@2
    inputs:
      credentialsOption: inputs
      serverUrl: ftp://localhost
      username: ftpuser
      password: Password@123
      rootDirectory: test-data
      filePatterns: '**'
      remoteDirectory: /
    displayName: FTP Upload

  ############################################
  # Verify FTP Upload
  ############################################
  - powershell: |
      Get-ChildItem C:\ftp -Recurse
    displayName: Verify FTP Files
