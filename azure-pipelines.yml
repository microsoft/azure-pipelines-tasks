parameters:
- name: build_single_task
  displayName: Build Single Task
  type: boolean
  default: true
- name: skip_job
  displayName: Skip this job for faster testing
  type: boolean
  default: false
- name: push_to_feed
  displayName: Push to Feed
  type: boolean
  default: false

variables:
  - name: tasksnames
    value: task1, task2

jobs:

- ${{ if parameters.build_single_task }}:
  - job: get_task_names
    pool:
      vmImage: ubuntu-20.04
    # we only test tasks on a PR and ignore forks since for security reasosns PAT tokens pipeline variable will not be available for fork's PRs.
    #condition: and(eq(variables['build.reason'], 'PullRequest'), eq(variables['System.PullRequest.IsFork'], 'False')) TODO: uncomment the line after testing
    steps:
    - script: npm install @octokit/core
      displayName: 'npm install @octokit/core'
    
    - bash: |
        TASKS=`node ./ci/testing/extractTaskNames.js $(PAT_Github) | xargs`
        echo $TASKS
        OUTPUT=`curl --user "":"$(ADOToken)" -H "Content-Type: application/json" -H "Accept:application/json" "https://dev.azure.com/canary2-poc/tasks-canary/_apis/pipelines/5/runs?api-version=7" -X POST -d "{\"templateParameters\": { \"tasks\": \"$TASKS\"}}"`
        echo $OUTPUT
      displayName: 'Extract task names'